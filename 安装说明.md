# Photo Watermark 2 - 安装说明

## 🆕 架构更新

**重要变化**：
- ✅ 新增OpenCV支持，图片水印性能大幅提升
- ✅ 水印管理模块分离（文本和图片独立处理）
- ✅ 新增依赖：opencv-python, numpy
- ⚠️ 旧文件`watermark_manager.py`已废弃

---

## 📋 系统要求

- **操作系统**：Windows 10/11（推荐），macOS，Linux
- **Python版本**：Python 3.7 或更高版本
- **磁盘空间**：至少 150MB（包含OpenCV）
- **内存**：建议4GB以上

## 🚀 快速安装

### 方法1：使用 requirements.txt（推荐）

```bash
# 1. 克隆或下载项目
cd Photo_Watermark_2

# 2. 安装所有依赖
pip install -r requirements.txt

# 3. 运行程序
python main.py
```

### 方法2：手动安装依赖

```bash
# 安装图像处理库（文本水印）
pip install Pillow>=9.0.0

# 安装图像处理库（图片水印）
pip install opencv-python>=4.8.0

# 安装数值计算库
pip install numpy>=1.24.0

# 安装拖拽支持库
pip install tkinterdnd2>=0.3.0

# 安装打包工具（可选）
pip install pyinstaller>=5.0.0

# 运行程序
python main.py
```

## 📦 依赖说明

### 必需依赖

1. **Pillow (PIL)**
   - 用途：文本水印渲染和图像处理
   - 版本：>= 9.0.0
   - 安装：`pip install Pillow`
   - 功能：字体渲染、文本水印、图像基础操作

2. **OpenCV (opencv-python)**
   - 用途：图片水印处理和Alpha混合
   - 版本：>= 4.8.0
   - 安装：`pip install opencv-python`
   - 功能：高性能图片叠加、透明度处理、图片缩放

3. **NumPy**
   - 用途：数值计算和图像数组操作
   - 版本：>= 1.24.0
   - 安装：`pip install numpy`
   - 功能：OpenCV依赖，图像数据处理

4. **tkinterdnd2**
   - 用途：拖拽导入功能
   - 版本：>= 0.3.0
   - 安装：`pip install tkinterdnd2`
   - 功能：Windows原生拖拽支持

### 可选依赖

5. **PyInstaller**
   - 用途：打包为独立可执行文件
   - 版本：>= 5.0.0
   - 安装：`pip install pyinstaller`
   - 功能：生成.exe文件

## 🔧 常见问题

### 问题1：tkinterdnd2 安装失败

**解决方案**：
```bash
# 尝试升级 pip
python -m pip install --upgrade pip

# 重新安装
pip install tkinterdnd2
```

如果仍然失败，程序会自动禁用拖拽功能，可以使用按钮导入图片。

### 问题2：OpenCV 安装失败

**症状**：`pip install opencv-python` 失败或超时

**解决方案**：
```bash
# 方法1：使用国内镜像源
pip install opencv-python -i https://pypi.tuna.tsinghua.edu.cn/simple

# 方法2：使用清华镜像安装所有依赖
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 方法3：升级pip后重试
python -m pip install --upgrade pip
pip install opencv-python
```

### 问题3：Pillow 安装失败

**解决方案**：
```bash
# Windows
pip install Pillow --user

# macOS/Linux
sudo pip install Pillow

# 使用镜像源
pip install Pillow -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 问题4：NumPy 安装失败或版本冲突

**症状**：提示NumPy版本不兼容

**解决方案**：
```bash
# 卸载旧版本
pip uninstall numpy

# 安装指定版本
pip install numpy>=1.24.0

# 或使用兼容版本
pip install numpy==1.24.3
```

### 问题5：中文字体不显示

**解决方案**：
程序会自动检测系统中文字体：
- Windows：微软雅黑、宋体、黑体
- macOS：需要安装中文字体
- Linux：需要安装中文字体包

### 问题6：程序启动慢

**解决方案**：
- 首次启动会加载字体列表，稍慢是正常的
- 后续启动会快很多
- OpenCV首次导入也需要一些时间

### 问题7：导入图片时出错

**症状**：`'JpegImageFile' object has no attribute 'read'`

**解决方案**：
- 这个错误已在最新版本修复
- 确保使用最新的代码
- 检查是否正确安装了opencv-python

### 问题8：图片水印不显示

**症状**：切换到图片水印标签页后，水印不显示

**解决方案**：
1. 确认已安装opencv-python：`pip list | findstr opencv`
2. 检查是否选择了水印图片
3. 检查透明度是否设置为0
4. 检查缩放比例是否过小

### 问题9：内存占用过大

**症状**：处理大量图片时内存占用高

**解决方案**：
- 这是正常的，图片处理需要内存
- 建议分批处理大量图片（每次50-100张）
- 处理完成后内存会自动释放

## 🎯 验证安装

### 检查依赖是否正确安装

```bash
# 检查所有依赖
pip list | findstr "Pillow opencv numpy tkinterdnd2"
```

应该看到类似输出：
```
numpy           1.24.3
opencv-python   4.8.1.78
Pillow          10.0.0
tkinterdnd2     0.3.0
```

### 快速验证

在Python中运行：
```python
# 验证所有依赖
import PIL
print(f"✓ Pillow 版本: {PIL.__version__}")

import cv2
print(f"✓ OpenCV 版本: {cv2.__version__}")

import numpy
print(f"✓ NumPy 版本: {numpy.__version__}")

try:
    import tkinterdnd2
    print("✓ tkinterdnd2 已安装")
except:
    print("⚠️ tkinterdnd2 未安装（拖拽功能不可用）")
```

### 运行测试脚本

```bash
python test_app.py
```

应该看到：
```
✓ 依赖库检查 通过
✓ 模块导入测试 通过
✓ 图片处理器测试 通过
✓ 文本水印管理器测试 通过
✓ 图片水印管理器测试 通过
✓ 配置管理器测试 通过
测试结果: 6/6 通过
🎉 所有测试通过！程序可以正常运行。
```

### 检查拖拽功能

启动程序后，在控制台查看：
```
✓ 拖拽功能已启用
```

如果看到此消息，说明拖拽功能正常。

## 📱 打包为可执行文件

### Windows

```bash
# 运行打包脚本
python build_exe.py

# 生成的文件
dist/PhotoWatermark2.exe              # 单文件版本
PhotoWatermark2_Portable/             # 便携版本
```

### macOS/Linux

```bash
# 使用 PyInstaller
pyinstaller --onefile --windowed --name=PhotoWatermark2 main.py
```

## 🔄 更新程序

```bash
# 更新依赖库
pip install --upgrade -r requirements.txt

# 运行程序
python main.py
```

## 💡 开发环境设置

如果你想修改代码：

```bash
# 安装开发依赖
pip install -r requirements.txt

# 运行测试
python test_app.py

# 启动程序
python main.py
```

## 📞 获取帮助

- 查看 **功能清单.md** 了解所有功能
- 查看 **USAGE.md** 了解详细使用方法
- 查看 **拖拽导入说明.md** 了解拖拽功能

## ✅ 安装完成检查清单

- [ ] Python 3.7+ 已安装
- [ ] 所有依赖已安装（运行 `pip list` 检查）
- [ ] 测试脚本通过（运行 `python test_app.py`）
- [ ] 程序可以启动（运行 `python main.py`）
- [ ] 拖拽功能正常（看到"拖拽功能已启用"消息）

全部完成后，即可开始使用 Photo Watermark 2！🎉

